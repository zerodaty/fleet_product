<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="view_fleet_vehicle_log_services_extend_form_inherit" model="ir.ui.view">
        <field name="name">fleet.vehicle.log.services.extend.form.inherit</field>
        <field name="model">fleet.vehicle.log.services</field>
        <field name="inherit_id" ref="fleet.fleet_vehicle_log_services_view_form"/>
        <field name="priority" eval='99' />
        <field name="arch" type="xml">

            <!-- BLOQUEO DEL FORMULARIO UNA VEZ CREADO EL PRESUPUESTO == FALTA IMPLEMENTAR == -->


            <!-- Arreglitos sencillos pal form MODOFICACION 1.0 agregar fotico y el domain-->

            <xpath expr="//field[@name='purchaser_id']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            
            <xpath expr="//field[@name='vehicle_id']" position="attributes">
                <attribute name="widget">many2one_avatar</attribute>
                <attribute name="domain">[('driver_id', '=', purchaser_id)]</attribute>
            </xpath>
            <xpath expr="//field[@name='vehicle_id']" position="before">
                <field name="purchaser_id" widget="many2one_avatar"/>
            </xpath>
            <!--
                AÑADIR EL CONTENEDOR PARA LOS BOTONES INTELIGENTES
                Lo insertamos justo al inicio del <sheet>
            -->
            <xpath expr="//div[hasclass('oe_button_box')]" position="inside">
                <button class="oe_stat_button" name="action_view_sale_orders" type="object" icon="fa-pencil-square-o" invisible="sale_order_count == 0">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_value">
                            <field name="sale_order_count" nolabel="1"/>
                        </span>
                        <span class="o_stat_text">Presupuesto(s)</span>
                    </div>
                </button>
            </xpath>

            <!-- GESTIÓN DE BOTONES EN LA CABECERA Y STATUSBAR -->
            <!-- Apuntamos a la cabecera para añadir nuestros botones y modificar la barra de estado. -->
            <xpath expr="//header" position="inside">
                <!-- Botón de Presupuesto -->
                <button name="action_create_sale_orders" string="Crear presupuesto" type="object" class="btn-primary" icon="fa-shopping-cart" invisible="state not in ['new', 'running'] or sale_order_id != False"/>
                <!-- Botones de Flujo de Trabajo -->
                <button name="action_in_progress" string="Iniciar Servicio" type="object" class="btn-secondary" icon="fa-arrow-right" invisible="state != 'new'"/>
                <button name="action_done" string="Finalizar" type="object" class="btn-success" icon="fa-check" invisible="state != 'running'"/>
                <button name="action_cancel" string="Cancelar" type="object" class="btn-danger" icon="fa-times" invisible="state not in ['new', 'running']"/>
            </xpath>
            <xpath expr="//header/field[@name='state']" position="attributes">
                <attribute name="statusbar_visible">new,running,done,cancelled</attribute>
                <attribute name="options">{}</attribute>
            </xpath>

            <!-- CAMPOS NUEVOS Y MODIFICACIONES -->
            <xpath expr="//field[@name='service_type_id']" position="after">
                <field name="service_classification"/>
            </xpath>
            <xpath expr="//field[@name='date']" position="after">
                <field name="estimated_delivery_date"/>
            </xpath>

            <xpath expr="//field[@name='amount']" position="replace">

                <field name="labor_cost" widget="monetary" string="Mano de Obra"/>
                <field name="parts_cost" widget="monetary" string="Costo Productos" readonly="1" force_save="1"/>
                <label for="amount" class="fw-bold"/>
                <div class="fw-bold">
                    <field name="amount" widget="monetary" nolabel="1" readonly="1" force_save="1"/>
                </div>
            </xpath>

            <!-- Pestaña de Productos (Notebook) -->
            <xpath expr="//field[@name='notes']" position="before">
                <notebook>
                    <page string="Productos Utilizados" name="product_lines">
                        <field name="product_line_ids">
                            <list string="Productos" editable="bottom">
                                <field name="product_id" domain="[('categ_id', 'child_of', categ_id), ('type', '!=', 'service')]" required="1"/>
                                <field name="categ_id" invisible="1"/>
                                <field name="quantity" string="Cant."/>
                                <field name="price_unit" string="Precio Unitario"/>
                                <field name="currency_id" invisible="1"/>
                                <field name="price_subtotal" sum="Total" readonly="1" force_save="1"/>
                            </list>
                        </field>
                    </page>

                </notebook>
            </xpath>

            <!-- 5. Campos de Seguro -->
            <xpath expr="//group[1]" position="after">
                <group string="Detalles del Seguro" name="insurance_details" invisible="vehicle_id_has_active_policies == False">
                    <field name="insurance_policy_id" domain="[('vehicle_id', '=', vehicle_id), ('policy_type', '=', 'owner'), ('end_date', '>=', date)]" context="{'default_vehicle_id': vehicle_id}"/>
                    <field name="insurance_coverage_amount"/>
                    <field name="net_cost" readonly="1" force_save="1"/>
                </group>
            </xpath>

            <!-- 
            
            RETIRADO pero por si a las moscas ta aqui

            6. Enlace visible al Pedido de Venta 
            <xpath expr="//field[@name='vehicle_id']" position="after">
                <field name="sale_order_id" readonly="1" invisible="sale_order_id == False"/>
            </xpath>
            -->


        </field>
    </record>

    <!-- Agregar clasificacion a la lista de servicios-->
    <record id="view_fleet_vehicle_log_services_extend_list_inherit" model="ir.ui.view">
        <field name="name">fleet.vehicle.log.services.extend.tree.inherit</field>
        <field name="model">fleet.vehicle.log.services</field>
        <field name="inherit_id" ref="fleet.fleet_vehicle_log_services_view_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='service_type_id']" position="after">
                <field name="service_classification" optional="show" widget="badge"/>
            </xpath>
        </field>
    </record>
</odoo>